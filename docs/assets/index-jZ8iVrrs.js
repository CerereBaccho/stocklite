(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const D=(e,t)=>t.some(n=>e instanceof n);let L,k;function U(){return L||(L=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function H(){return k||(k=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const E=new WeakMap,P=new WeakMap,I=new WeakMap;function _(e){const t=new Promise((n,i)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",s)},o=()=>{n(m(e.result)),r()},s=()=>{i(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",s)});return I.set(t,e),t}function z(e){if(E.has(e))return;const t=new Promise((n,i)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",s),e.removeEventListener("abort",s)},o=()=>{n(),r()},s=()=>{i(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",s),e.addEventListener("abort",s)});E.set(e,t)}let O={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return E.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return m(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function R(e){O=e(O)}function G(e){return H().includes(e)?function(...t){return e.apply($(this),t),m(this.request)}:function(...t){return m(e.apply($(this),t))}}function Q(e){return typeof e=="function"?G(e):(e instanceof IDBTransaction&&z(e),D(e,U())?new Proxy(e,O):e)}function m(e){if(e instanceof IDBRequest)return _(e);if(P.has(e))return P.get(e);const t=Q(e);return t!==e&&(P.set(e,t),I.set(t,e)),t}const $=e=>I.get(e);function Y(e,t,{blocked:n,upgrade:i,blocking:r,terminated:o}={}){const s=indexedDB.open(e,t),c=m(s);return i&&s.addEventListener("upgradeneeded",a=>{i(m(s.result),a.oldVersion,a.newVersion,m(s.transaction),a)}),n&&s.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),c.then(a=>{o&&a.addEventListener("close",()=>o()),r&&a.addEventListener("versionchange",d=>r(d.oldVersion,d.newVersion,d))}).catch(()=>{}),c}const J=["get","getKey","getAll","getAllKeys","count"],X=["put","add","delete","clear"],v=new Map;function B(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(v.get(t))return v.get(t);const n=t.replace(/FromIndex$/,""),i=t!==n,r=X.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!(r||J.includes(n)))return;const o=async function(s,...c){const a=this.transaction(s,r?"readwrite":"readonly");let d=a.store;return i&&(d=d.index(c.shift())),(await Promise.all([d[n](...c),r&&a.done]))[0]};return v.set(t,o),o}R(e=>({...e,get:(t,n,i)=>B(t,n)||e.get(t,n,i),has:(t,n)=>!!B(t,n)||e.has(t,n)}));const Z=["continue","continuePrimaryKey","advance"],A={},x=new WeakMap,q=new WeakMap,ee={get(e,t){if(!Z.includes(t))return e[t];let n=A[t];return n||(n=A[t]=function(...i){x.set(this,q.get(this)[t](...i))}),n}};async function*te(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,ee);for(q.set(n,t),I.set(n,$(t));t;)yield n,t=await(x.get(n)||t.continue()),x.delete(n)}function M(e,t){return t===Symbol.asyncIterator&&D(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&D(e,[IDBIndex,IDBObjectStore])}R(e=>({...e,get(t,n,i){return M(t,n)?te:e.get(t,n,i)},has(t,n){return M(t,n)||e.has(t,n)}}));const ne="stocklite",re=1;let p;function w(e=new Date){return new Date(e).toISOString()}p=Y(ne,re,{upgrade(e){e.createObjectStore("items",{keyPath:"id"}).createIndex("byCategory","category"),e.createObjectStore("history",{keyPath:["itemId","date"]})}});const j={async getItems(){return(await p).getAll("items")},async upsert(e){const t=await p;e.updatedAt=w(),await t.put("items",e)},async adjustQty(e,t){const i=(await p).transaction(["items","history"],"readwrite"),r=await i.objectStore("items").get(e);if(!r)return;const o=r.qty;r.qty=Math.max(0,o+t),t>0&&(r.lastRefillAt=w());const c=(await i.objectStore("history").getAll()).filter(a=>a.itemId===e&&a.type==="補充").map(a=>+new Date(a.date)).sort((a,d)=>d-a);if(c.length>=2){const a=[];for(let g=0;g<Math.min(3,c.length-1);g++)a.push(c[g]-c[g+1]);const d=a.reduce((g,V)=>g+V,0)/a.length;r.nextRefillAt=w(new Date(Date.now()+d))}await i.objectStore("items").put(r),await i.objectStore("history").put({itemId:e,date:w(),delta:t,type:t>0?"補充":"消費"}),await i.done},async getHistory(e,t){const i=await(await p).getAll("history"),r=new Date;return r.setMonth(r.getMonth()-t),i.filter(o=>o.itemId===e&&new Date(o.date)>=r).sort((o,s)=>+new Date(o.date)-+new Date(s.date))},async exportCSV(e=1){const n=await(await p).getAll("history"),i=new Date;i.setFullYear(i.getFullYear()-e);const r=[["itemId","date","delta","type"]];return n.filter(o=>new Date(o.date)>=i).forEach(o=>r.push([o.itemId,o.date,String(o.delta),o.type])),r.map(o=>o.join(",")).join(`
`)}};async function oe(e){const t=await p;if((await t.getAllKeys("items")).length>0)return;const n=t.transaction("items","readwrite");for(const i of e)await n.store.put(i);await n.done}const N=new Date().toISOString(),l=(e,t,n=1)=>({id:crypto.randomUUID(),name:e,qty:1,threshold:n,lastRefillAt:N,nextRefillAt:"",updatedAt:N,deleted:!1,version:1,category:t}),ie=[l("トイレットペーパー","キッチン"),l("キッチンペーパー","キッチン"),l("ラップ","キッチン"),l("食器洗剤","キッチン"),l("スポンジ","キッチン"),l("排水溝ネット","キッチン"),l("歯磨き粉","洗面・トイレ"),l("シャンプー","洗面・トイレ"),l("ボディソープ","洗面・トイレ"),l("トイレ用洗剤","洗面・トイレ")],se="8e78387b-2f78-4458-907e-938de4df59f6",ae=e=>document.querySelector(e);function u(e){const t=ae("#diag");if(!t)return;const n=new Date().toISOString().slice(11,19);t.textContent=`${t.textContent??""}${n} ${e}
`}window.onerror=function(e,t,n,i,r){return u(`[ERROR] ${String(e)} @${t}:${n}:${i}
${r?.stack??""}`),!1};window.onunhandledrejection=function(e){const t=e.reason;u(`[UNHANDLED] ${t?.message??String(t)}
${t?.stack??""}`)};function F(){const e=navigator.platform||"",t=/Mac/i.test(e)&&navigator.maxTouchPoints>1;return/iPhone|iPad|iPod/i.test(e)||t}function K(){return window.matchMedia?.("(display-mode: standalone)")?.matches||navigator.standalone===!0}const ce=e=>{if(!e)return"--/--";const t=new Date(e);return isNaN(+t)?"--/--":`${String(t.getMonth()+1).padStart(2,"0")}/${String(t.getDate()).padStart(2,"0")}`};function W(e){const t=e.qty<=e.threshold;return`
  <div class="card" data-id="${e.id}">
    <div class="row1">
      ${t?'<span class="tag danger">要補充</span>':""}
      <span class="item-name ${t?"":"no-tag"}">${e.name}</span>
    </div>
    <div class="row2">
      <span class="qty">個数：<b>${e.qty}</b></span>
      <div class="actions">
        <button class="btn minus" data-id="${e.id}" data-delta="-1">－</button>
        <button class="btn plus"  data-id="${e.id}" data-delta="1">＋</button>
      </div>
    </div>
    <div class="row3">次回補充：${ce(e.nextRefillAt)}</div>
  </div>`}async function S(){const e=document.getElementById("app"),t=await j.getItems(),n={キッチン:[],"洗面・トイレ":[]};for(const i of t)i.deleted||n[i.category].push(i);for(const i of Object.keys(n))n[i].sort((r,o)=>r.name.localeCompare(o.name,"ja-JP"));e.innerHTML=`
    <div class="offline ${navigator.onLine?"hide":""}">オフライン閲覧中</div>
    <h2 class="cat">【キッチン】</h2>
    ${n.キッチン.map(W).join("")||'<div class="empty">なし</div>'}
    <h2 class="cat">【洗面・トイレ】</h2>
    ${n["洗面・トイレ"].map(W).join("")||'<div class="empty">なし</div>'}
  `,e.onclick=async i=>{const r=i.target;if(!r||!r.classList.contains("btn"))return;const o=r.dataset.id,s=Number(r.dataset.delta||0);!o||!s||(await j.adjustQty(o,s),await S(),await f())}}async function f(){const e=document.getElementById("diag");if(!e)return;const t=typeof Notification<"u"&&"permission"in Notification?Notification.permission:"n/a",n=F(),i=K(),r=n?i:!0;let o="n/a";try{window.OneSignal?.User?.PushSubscription?.optedIn!=null?o=String(window.OneSignal.User.PushSubscription.optedIn):window.OneSignal?.isPushNotificationsEnabled&&(o=String(await window.OneSignal.isPushNotificationsEnabled()))}catch{}let s=[];try{s=(await navigator.serviceWorker?.getRegistrations?.()??[]).map(d=>`- scope: ${d.scope}`)}catch{}e.textContent=`[DIAG]
  mode: ${i?"standalone":"browser"}
  ios: ${n}
  eligible(iOS=PWAのみ): ${r}
  permission: ${t}
  subscribed: ${o}
  APP_ID: present
  origin: ${location.origin}
  path:   ${location.pathname}
  SW:
${s.length?s.join(`
`):"- (none)"}
`;const c=document.getElementById("perm-badge");c&&(c.textContent=`権限: ${t}`),h()}async function de(){if(!("serviceWorker"in navigator)){u("SW API unavailable");return}try{(await navigator.serviceWorker.getRegistrations()).some(n=>n.scope.includes("/stocklite/"))?u("SW already present for /stocklite/"):(await navigator.serviceWorker.register("/stocklite/OneSignalSDKWorker.js",{scope:"/stocklite/"}),u("SW registered: /stocklite/OneSignalSDKWorker.js"))}catch(e){u(`SW register error: ${e?.message||e}`)}}function ue(){return new Promise(e=>{try{window.OneSignal=window.OneSignal||[],window.OneSignal.push(()=>{try{window.OneSignal.init({appId:se,serviceWorkerPath:"/stocklite/OneSignalSDKWorker.js",serviceWorkerUpdaterPath:"/stocklite/OneSignalSDKUpdaterWorker.js",serviceWorkerParam:{scope:"/stocklite/"},promptOptions:{slidedown:{enabled:!1}}}),e()}catch(t){u(`OneSignal.init error: ${t?.message||t}`),e()}})}catch(t){u(`OneSignal bootstrap error: ${t?.message||t}`),e()}})}function le(){try{const e=Notification?.requestPermission;if(typeof e=="function")return e(),setTimeout(f,250),setTimeout(f,1e3),!0}catch(e){u(`iOS PWA requestPermission error: ${e?.message||e}`)}return!1}function fe(){let e=!1;try{window.OneSignal?.Notifications?.requestPermission&&(window.OneSignal.Notifications.requestPermission(),e=!0)}catch{}try{window.OneSignal?.Slidedown?.promptPush&&(window.OneSignal.Slidedown.promptPush(),e=!0)}catch{}try{const t=Notification?.requestPermission;typeof t=="function"&&(t(),e=!0)}catch{}return e?(setTimeout(f,250),setTimeout(f,1e3)):u("No permission prompt API available"),e}let y=!1,C=!1,T=null;function pe(e){if(!e)return!1;const t=e;return!!(t.id==="enable-push"||t.closest?.("#enable-push")||t.dataset?.action==="enable-push"||t.closest?.('[data-action="enable-push"]')||t.id==="enable-push-fab")}function b(e){if(!y){y=!0,u(`[enable-push] ${e} received → try prompt`);try{const t=F(),n=K();(t&&n?le():fe())||(y=!1)}catch(t){u(`[enable-push] error: ${t?.message||t}`),y=!1}}}function me(){if(C)return;C=!0;const e=t=>{const n=t.target;pe(n)&&b(t.type)};document.addEventListener("pointerdown",e,{capture:!0,passive:!0}),document.addEventListener("touchend",e,{capture:!0,passive:!0}),document.addEventListener("click",e,{capture:!0}),T=new MutationObserver(()=>{(document.getElementById("enable-push")||document.querySelector('[data-action="enable-push"]'))&&u("[enable-push] button detected in DOM")}),T.observe(document.documentElement,{childList:!0,subtree:!0})}function ge(){if(document.getElementById("enable-push-fab"))return;const e=document.createElement("button");e.id="enable-push-fab",e.textContent="通知を有効化",Object.assign(e.style,{position:"fixed",right:"16px",bottom:"16px",padding:"12px 14px",borderRadius:"24px",border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.2)",fontSize:"16px",zIndex:"2147483647",background:"#2b7cff",color:"#fff",letterSpacing:"0.02em",display:"none"}),e.setAttribute("aria-label","通知を有効化"),document.body.appendChild(e)}function h(){const e=document.getElementById("enable-push-fab");if(!e)return;const t=typeof Notification<"u"&&"permission"in Notification?Notification.permission:"n/a";e.style.display=t==="default"?"block":"none"}function he(){const e=document.getElementById("enable-push-fab");e&&(e.addEventListener("pointerdown",()=>b("pointerdown(fab)"),{capture:!0,passive:!0}),e.addEventListener("touchend",()=>b("touchend(fab)"),{capture:!0,passive:!0}),e.addEventListener("click",()=>b("click(fab)"),{capture:!0}))}(async()=>{await oe(ie),await S(),await de(),await ue(),await f(),ge(),he(),h(),me(),window.addEventListener("online",()=>{S(),f(),h()}),window.addEventListener("offline",()=>{S(),f(),h()}),window.addEventListener("visibilitychange",()=>{f(),h()});const e=document.getElementById("enable-push");e&&e.addEventListener("click",()=>b("click(direct)"))})();

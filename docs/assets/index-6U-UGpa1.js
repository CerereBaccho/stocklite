(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const P=(t,e)=>e.some(n=>t instanceof n);let E,L;function K(){return E||(E=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function V(){return L||(L=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const D=new WeakMap,S=new WeakMap,h=new WeakMap;function _(t){const e=new Promise((n,r)=>{const o=()=>{t.removeEventListener("success",s),t.removeEventListener("error",i)},s=()=>{n(g(t.result)),o()},i=()=>{r(t.error),o()};t.addEventListener("success",s),t.addEventListener("error",i)});return h.set(e,t),e}function F(t){if(D.has(t))return;const e=new Promise((n,r)=>{const o=()=>{t.removeEventListener("complete",s),t.removeEventListener("error",i),t.removeEventListener("abort",i)},s=()=>{n(),o()},i=()=>{r(t.error||new DOMException("AbortError","AbortError")),o()};t.addEventListener("complete",s),t.addEventListener("error",i),t.addEventListener("abort",i)});D.set(t,e)}let O={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return D.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return g(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function N(t){O=t(O)}function U(t){return V().includes(t)?function(...e){return t.apply(v(this),e),g(this.request)}:function(...e){return g(t.apply(v(this),e))}}function H(t){return typeof t=="function"?U(t):(t instanceof IDBTransaction&&F(t),P(t,K())?new Proxy(t,O):t)}function g(t){if(t instanceof IDBRequest)return _(t);if(S.has(t))return S.get(t);const e=H(t);return e!==t&&(S.set(t,e),h.set(e,t)),e}const v=t=>h.get(t);function Y(t,e,{blocked:n,upgrade:r,blocking:o,terminated:s}={}){const i=indexedDB.open(t,e),c=g(i);return r&&i.addEventListener("upgradeneeded",a=>{r(g(i.result),a.oldVersion,a.newVersion,g(i.transaction),a)}),n&&i.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),c.then(a=>{s&&a.addEventListener("close",()=>s()),o&&a.addEventListener("versionchange",d=>o(d.oldVersion,d.newVersion,d))}).catch(()=>{}),c}const G=["get","getKey","getAll","getAllKeys","count"],Q=["put","add","delete","clear"],b=new Map;function k(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(b.get(e))return b.get(e);const n=e.replace(/FromIndex$/,""),r=e!==n,o=Q.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(o||G.includes(n)))return;const s=async function(i,...c){const a=this.transaction(i,o?"readwrite":"readonly");let d=a.store;return r&&(d=d.index(c.shift())),(await Promise.all([d[n](...c),o&&a.done]))[0]};return b.set(e,s),s}N(t=>({...t,get:(e,n,r)=>k(e,n)||t.get(e,n,r),has:(e,n)=>!!k(e,n)||t.has(e,n)}));const J=["continue","continuePrimaryKey","advance"],A={},$=new WeakMap,C=new WeakMap,z={get(t,e){if(!J.includes(e))return t[e];let n=A[e];return n||(n=A[e]=function(...r){$.set(this,C.get(this)[e](...r))}),n}};async function*X(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,z);for(C.set(n,e),h.set(n,v(e));e;)yield n,e=await($.get(n)||e.continue()),$.delete(n)}function M(t,e){return e===Symbol.asyncIterator&&P(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&P(t,[IDBIndex,IDBObjectStore])}N(t=>({...t,get(e,n,r){return M(e,n)?X:t.get(e,n,r)},has(e,n){return M(e,n)||t.has(e,n)}}));const Z="stocklite",tt=1;let m;function w(t=new Date){return new Date(t).toISOString()}m=Y(Z,tt,{upgrade(t){t.createObjectStore("items",{keyPath:"id"}).createIndex("byCategory","category"),t.createObjectStore("history",{keyPath:["itemId","date"]})}});const B={async getItems(){return(await m).getAll("items")},async upsert(t){const e=await m;t.updatedAt=w(),await e.put("items",t)},async adjustQty(t,e){const r=(await m).transaction(["items","history"],"readwrite"),o=await r.objectStore("items").get(t);if(!o)return;const s=o.qty;o.qty=Math.max(0,s+e),e>0&&(o.lastRefillAt=w());const c=(await r.objectStore("history").getAll()).filter(a=>a.itemId===t&&a.type==="補充").map(a=>+new Date(a.date)).sort((a,d)=>d-a);if(c.length>=2){const a=[];for(let p=0;p<Math.min(3,c.length-1);p++)a.push(c[p]-c[p+1]);const d=a.reduce((p,q)=>p+q,0)/a.length;o.nextRefillAt=w(new Date(Date.now()+d))}await r.objectStore("items").put(o),await r.objectStore("history").put({itemId:t,date:w(),delta:e,type:e>0?"補充":"消費"}),await r.done},async getHistory(t,e){const r=await(await m).getAll("history"),o=new Date;return o.setMonth(o.getMonth()-e),r.filter(s=>s.itemId===t&&new Date(s.date)>=o).sort((s,i)=>+new Date(s.date)-+new Date(i.date))},async exportCSV(t=1){const n=await(await m).getAll("history"),r=new Date;r.setFullYear(r.getFullYear()-t);const o=[["itemId","date","delta","type"]];return n.filter(s=>new Date(s.date)>=r).forEach(s=>o.push([s.itemId,s.date,String(s.delta),s.type])),o.map(s=>s.join(",")).join(`
`)}};async function et(t){const e=await m;if((await e.getAllKeys("items")).length>0)return;const n=e.transaction("items","readwrite");for(const r of t)await n.store.put(r);await n.done}const j=new Date().toISOString(),l=(t,e,n=1)=>({id:crypto.randomUUID(),name:t,qty:1,threshold:n,lastRefillAt:j,nextRefillAt:"",updatedAt:j,deleted:!1,version:1,category:e}),nt=[l("トイレットペーパー","キッチン"),l("キッチンペーパー","キッチン"),l("ラップ","キッチン"),l("食器洗剤","キッチン"),l("スポンジ","キッチン"),l("排水溝ネット","キッチン"),l("歯磨き粉","洗面・トイレ"),l("シャンプー","洗面・トイレ"),l("ボディソープ","洗面・トイレ"),l("トイレ用洗剤","洗面・トイレ")],ot="8e78387b-2f78-4458-907e-938de4df59f6",rt=t=>document.querySelector(t);function u(t){const e=rt("#diag");if(!e)return;const n=new Date().toISOString().slice(11,19);e.textContent=`${e.textContent??""}${n} ${t}
`}window.onerror=function(t,e,n,r,o){return u(`[ERROR] ${String(t)} @${e}:${n}:${r}
${o?.stack??""}`),!1};window.onunhandledrejection=function(t){const e=t.reason;u(`[UNHANDLED] ${e?.message??String(e)}
${e?.stack??""}`)};function T(){const t=navigator.platform||"",e=/Mac/i.test(t)&&navigator.maxTouchPoints>1;return/iPhone|iPad|iPod/i.test(t)||e}function R(){return window.matchMedia?.("(display-mode: standalone)")?.matches||navigator.standalone===!0}const st=t=>{if(!t)return"--/--";const e=new Date(t);return isNaN(+e)?"--/--":`${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}`};function W(t){const e=t.qty<=t.threshold;return`
  <div class="card" data-id="${t.id}">
    <div class="row1">
      ${e?'<span class="tag danger">要補充</span>':""}
      <span class="item-name ${e?"":"no-tag"}">${t.name}</span>
    </div>
    <div class="row2">
      <span class="qty">個数：<b>${t.qty}</b></span>
      <div class="actions">
        <button class="btn minus" data-id="${t.id}" data-delta="-1">－</button>
        <button class="btn plus"  data-id="${t.id}" data-delta="1">＋</button>
      </div>
    </div>
    <div class="row3">次回補充：${st(t.nextRefillAt)}</div>
  </div>`}const x="sl_push_prompted_once";let I=!1;function it(){try{const t=Notification?.requestPermission;if(typeof t=="function")return t(),setTimeout(f,250),setTimeout(f,1e3),!0}catch(t){u(`iOS PWA requestPermission error: ${t?.message||t}`)}return!1}function at(){let t=!1;try{window.OneSignal?.Notifications?.requestPermission&&(window.OneSignal.Notifications.requestPermission(),t=!0)}catch{}try{window.OneSignal?.Slidedown?.promptPush&&(window.OneSignal.Slidedown.promptPush(),t=!0)}catch{}try{const e=Notification?.requestPermission;typeof e=="function"&&(e(),t=!0)}catch{}return t?(setTimeout(f,250),setTimeout(f,1e3)):u("No permission prompt API available"),t}function ct(t){if(I)return;if(localStorage.getItem(x)==="1"){u("[first-prompt] skipped: already prompted once");return}I=!0;const e=T(),n=R(),r=e&&n?it():at();r&&localStorage.setItem(x,"1"),u(`[first-prompt] via ${t} used:${r}`),r||(I=!1)}async function y(){const t=document.getElementById("app"),e=await B.getItems(),n={キッチン:[],"洗面・トイレ":[]};for(const r of e)r.deleted||n[r.category].push(r);for(const r of Object.keys(n))n[r].sort((o,s)=>o.name.localeCompare(s.name,"ja-JP"));t.innerHTML=`
    <div class="offline ${navigator.onLine?"hide":""}">オフライン閲覧中</div>
    <h2 class="cat">【キッチン】</h2>
    ${n.キッチン.map(W).join("")||'<div class="empty">なし</div>'}
    <h2 class="cat">【洗面・トイレ】</h2>
    ${n["洗面・トイレ"].map(W).join("")||'<div class="empty">なし</div>'}
  `,t.addEventListener("pointerdown",r=>{const o=r.target;!o||!o.classList.contains("btn")||u(`[btn] pointerdown ${o.classList.contains("plus")?"+btn":"-btn"}`)},{capture:!0,passive:!0}),t.addEventListener("click",r=>{const o=r.target;if(!o||!o.classList.contains("btn"))return;ct(o.classList.contains("plus")?"+btn":"-btn");const s=o.dataset.id,i=Number(o.dataset.delta||0);!s||!i||(async()=>(await B.adjustQty(s,i),await y(),await f()))()},{capture:!1})}async function f(){const t=document.getElementById("diag");if(!t)return;const e=typeof Notification<"u"&&"permission"in Notification?Notification.permission:"n/a",n=T(),r=R(),o=n?r:!0;let s="n/a";try{window.OneSignal?.User?.PushSubscription?.optedIn!=null?s=String(window.OneSignal.User.PushSubscription.optedIn):window.OneSignal?.isPushNotificationsEnabled&&(s=String(await window.OneSignal.isPushNotificationsEnabled()))}catch{}let i=[];try{i=(await navigator.serviceWorker?.getRegistrations?.()??[]).map(d=>`- scope: ${d.scope}`)}catch{}t.textContent=`[DIAG]
  mode: ${r?"standalone":"browser"}
  ios: ${n}
  eligible(iOS=PWAのみ): ${o}
  permission: ${e}
  subscribed: ${s}
  APP_ID: present
  origin: ${location.origin}
  path:   ${location.pathname}
  SW:
${i.length?i.join(`
`):"- (none)"}
`;const c=document.getElementById("perm-badge");c&&(c.textContent=`権限: ${e}`)}async function dt(){if(!("serviceWorker"in navigator)){u("SW API unavailable");return}try{(await navigator.serviceWorker.getRegistrations()).some(n=>n.scope.includes("/stocklite/"))?u("SW already present for /stocklite/"):(await navigator.serviceWorker.register("/stocklite/OneSignalSDKWorker.js",{scope:"/stocklite/"}),u("SW registered: /stocklite/OneSignalSDKWorker.js"))}catch(t){u(`SW register error: ${t?.message||t}`)}}function ut(){return new Promise(t=>{try{window.OneSignal=window.OneSignal||[],window.OneSignal.push(()=>{try{window.OneSignal.init({appId:ot,serviceWorkerPath:"/stocklite/OneSignalSDKWorker.js",serviceWorkerUpdaterPath:"/stocklite/OneSignalSDKUpdaterWorker.js",serviceWorkerParam:{scope:"/stocklite/"},promptOptions:{slidedown:{enabled:!1}}}),t()}catch(e){u(`OneSignal.init error: ${e?.message||e}`),t()}})}catch(e){u(`OneSignal bootstrap error: ${e?.message||e}`),t()}})}(async()=>(await et(nt),await y(),await dt(),await ut(),await f(),window.addEventListener("online",()=>{y(),f()}),window.addEventListener("offline",()=>{y(),f()})))();

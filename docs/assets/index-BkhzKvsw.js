(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const O=(t,e)=>e.some(n=>t instanceof n);let A,M;function _(){return A||(A=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function F(){return M||(M=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const $=new WeakMap,D=new WeakMap,S=new WeakMap;function U(t){const e=new Promise((n,i)=>{const r=()=>{t.removeEventListener("success",o),t.removeEventListener("error",s)},o=()=>{n(w(t.result)),r()},s=()=>{i(t.error),r()};t.addEventListener("success",o),t.addEventListener("error",s)});return S.set(e,t),e}function H(t){if($.has(t))return;const e=new Promise((n,i)=>{const r=()=>{t.removeEventListener("complete",o),t.removeEventListener("error",s),t.removeEventListener("abort",s)},o=()=>{n(),r()},s=()=>{i(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",o),t.addEventListener("error",s),t.addEventListener("abort",s)});$.set(t,e)}let E={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return $.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return w(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function R(t){E=t(E)}function Y(t){return F().includes(t)?function(...e){return t.apply(L(this),e),w(this.request)}:function(...e){return w(t.apply(L(this),e))}}function G(t){return typeof t=="function"?Y(t):(t instanceof IDBTransaction&&H(t),O(t,_())?new Proxy(t,E):t)}function w(t){if(t instanceof IDBRequest)return U(t);if(D.has(t))return D.get(t);const e=G(t);return e!==t&&(D.set(t,e),S.set(e,t)),e}const L=t=>S.get(t);function Q(t,e,{blocked:n,upgrade:i,blocking:r,terminated:o}={}){const s=indexedDB.open(t,e),d=w(s);return i&&s.addEventListener("upgradeneeded",a=>{i(w(s.result),a.oldVersion,a.newVersion,w(s.transaction),a)}),n&&s.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),d.then(a=>{o&&a.addEventListener("close",()=>o()),r&&a.addEventListener("versionchange",u=>r(u.oldVersion,u.newVersion,u))}).catch(()=>{}),d}const J=["get","getKey","getAll","getAllKeys","count"],z=["put","add","delete","clear"],P=new Map;function B(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(P.get(e))return P.get(e);const n=e.replace(/FromIndex$/,""),i=e!==n,r=z.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!(r||J.includes(n)))return;const o=async function(s,...d){const a=this.transaction(s,r?"readwrite":"readonly");let u=a.store;return i&&(u=u.index(d.shift())),(await Promise.all([u[n](...d),r&&a.done]))[0]};return P.set(e,o),o}R(t=>({...t,get:(e,n,i)=>B(e,n)||t.get(e,n,i),has:(e,n)=>!!B(e,n)||t.has(e,n)}));const X=["continue","continuePrimaryKey","advance"],j={},k=new WeakMap,q=new WeakMap,Z={get(t,e){if(!X.includes(e))return t[e];let n=j[e];return n||(n=j[e]=function(...i){k.set(this,q.get(this)[e](...i))}),n}};async function*tt(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,Z);for(q.set(n,e),S.set(n,L(e));e;)yield n,e=await(k.get(n)||e.continue()),k.delete(n)}function W(t,e){return e===Symbol.asyncIterator&&O(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&O(t,[IDBIndex,IDBObjectStore])}R(t=>({...t,get(e,n,i){return W(e,n)?tt:t.get(e,n,i)},has(e,n){return W(e,n)||t.has(e,n)}}));const et="stocklite",nt=1;let g;function h(t=new Date){return new Date(t).toISOString()}g=Q(et,nt,{upgrade(t){t.createObjectStore("items",{keyPath:"id"}).createIndex("byCategory","category"),t.createObjectStore("history",{keyPath:["itemId","date"]})}});const x={async getItems(){return(await g).getAll("items")},async upsert(t){const e=await g;t.updatedAt=h(),await e.put("items",t)},async adjustQty(t,e){const i=(await g).transaction(["items","history"],"readwrite"),r=await i.objectStore("items").get(t);if(!r)return;const o=r.qty;r.qty=Math.max(0,o+e),e>0&&(r.lastRefillAt=h());const d=(await i.objectStore("history").getAll()).filter(a=>a.itemId===t&&a.type==="補充").map(a=>+new Date(a.date)).sort((a,u)=>u-a);if(d.length>=2){const a=[];for(let l=0;l<Math.min(3,d.length-1);l++)a.push(d[l]-d[l+1]);const u=a.reduce((l,p)=>l+p,0)/a.length;r.nextRefillAt=h(new Date(Date.now()+u))}await i.objectStore("items").put(r),await i.objectStore("history").put({itemId:t,date:h(),delta:e,type:e>0?"補充":"消費"}),await i.done},async getHistory(t,e){const i=await(await g).getAll("history"),r=new Date;return r.setMonth(r.getMonth()-e),i.filter(o=>o.itemId===t&&new Date(o.date)>=r).sort((o,s)=>+new Date(o.date)-+new Date(s.date))},async exportCSV(t=1){const n=await(await g).getAll("history"),i=new Date;i.setFullYear(i.getFullYear()-t);const r=[["itemId","date","delta","type"]];return n.filter(o=>new Date(o.date)>=i).forEach(o=>r.push([o.itemId,o.date,String(o.delta),o.type])),r.map(o=>o.join(",")).join(`
`)}};async function rt(t){const e=await g;if((await e.getAllKeys("items")).length>0)return;const n=e.transaction("items","readwrite");for(const i of t)await n.store.put(i);await n.done}const N=new Date().toISOString(),f=(t,e,n=1)=>({id:crypto.randomUUID(),name:t,qty:1,threshold:n,lastRefillAt:N,nextRefillAt:"",updatedAt:N,deleted:!1,version:1,category:e}),it=[f("トイレットペーパー","キッチン"),f("キッチンペーパー","キッチン"),f("ラップ","キッチン"),f("食器洗剤","キッチン"),f("スポンジ","キッチン"),f("排水溝ネット","キッチン"),f("歯磨き粉","洗面・トイレ"),f("シャンプー","洗面・トイレ"),f("ボディソープ","洗面・トイレ"),f("トイレ用洗剤","洗面・トイレ")],ot="8e78387b-2f78-4458-907e-938de4df59f6",st=t=>document.querySelector(t);function c(t){const e=st("#diag");if(!e)return;const n=new Date().toISOString().slice(11,19);e.textContent=`${e.textContent??""}${n} ${t}
`}window.onerror=function(t,e,n,i,r){return c(`[ERROR] ${String(t)} @${e}:${n}:${i}
${r?.stack??""}`),!1};window.onunhandledrejection=function(t){const e=t.reason;c(`[UNHANDLED] ${e?.message??String(e)}
${e?.stack??""}`)};function K(){const t=navigator.platform||"",e=/Mac/i.test(t)&&navigator.maxTouchPoints>1;return/iPhone|iPad|iPod/i.test(t)||e}function V(){return window.matchMedia?.("(display-mode: standalone)")?.matches||navigator.standalone===!0}const at=t=>{if(!t)return"--/--";const e=new Date(t);return isNaN(+e)?"--/--":`${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}`};function T(t){const e=t.qty<=t.threshold;return`
  <div class="card" data-id="${t.id}">
    <div class="row1">
      ${e?'<span class="tag danger">要補充</span>':""}
      <span class="item-name ${e?"":"no-tag"}">${t.name}</span>
    </div>
    <div class="row2">
      <span class="qty">個数：<b>${t.qty}</b></span>
      <div class="actions">
        <button class="btn minus" data-id="${t.id}" data-delta="-1">－</button>
        <button class="btn plus"  data-id="${t.id}" data-delta="1">＋</button>
      </div>
    </div>
    <div class="row3">次回補充：${at(t.nextRefillAt)}</div>
  </div>`}const C="sl_push_prompted_once";let v=!1;function ct(){try{const t=Notification?.requestPermission;if(typeof t=="function")return t(),setTimeout(m,250),setTimeout(m,1e3),setTimeout(()=>y("after-iOS-permission"),500),setTimeout(()=>y("after-iOS-permission(2)"),1500),!0}catch(t){c(`iOS PWA requestPermission error: ${t?.message||t}`)}return!1}function dt(){let t=!1;try{window.OneSignal?.Notifications?.requestPermission&&(window.OneSignal.Notifications.requestPermission(),t=!0)}catch{}try{window.OneSignal?.Slidedown?.promptPush&&(window.OneSignal.Slidedown.promptPush(),t=!0)}catch{}try{const e=Notification?.requestPermission;typeof e=="function"&&(e(),t=!0)}catch{}return t?(setTimeout(m,250),setTimeout(m,1e3),setTimeout(()=>y("after-other-permission"),500),setTimeout(()=>y("after-other-permission(2)"),1500)):c("No permission prompt API available"),t}function ut(t){if(v)return;if(localStorage.getItem(C)==="1"){c("[first-prompt] skipped: already prompted once");return}v=!0;const e=K(),n=V(),i=e&&n?ct():dt();i&&localStorage.setItem(C,"1"),c(`[first-prompt] via ${t} used:${i}`),i||(v=!1)}async function b(){const t=document.getElementById("app"),e=await x.getItems(),n={キッチン:[],"洗面・トイレ":[]};for(const i of e)i.deleted||n[i.category].push(i);for(const i of Object.keys(n))n[i].sort((r,o)=>r.name.localeCompare(o.name,"ja-JP"));t.innerHTML=`
    <div class="offline ${navigator.onLine?"hide":""}">オフライン閲覧中</div>
    <h2 class="cat">【キッチン】</h2>
    ${n.キッチン.map(T).join("")||'<div class="empty">なし</div>'}
    <h2 class="cat">【洗面・トイレ】</h2>
    ${n["洗面・トイレ"].map(T).join("")||'<div class="empty">なし</div>'}
  `,t.addEventListener("pointerdown",i=>{const r=i.target;!r||!r.classList.contains("btn")||c(`[btn] pointerdown ${r.classList.contains("plus")?"+btn":"-btn"}`)},{capture:!0,passive:!0}),t.addEventListener("click",i=>{const r=i.target;if(!r||!r.classList.contains("btn"))return;ut(r.classList.contains("plus")?"+btn":"-btn");const o=r.dataset.id,s=Number(r.dataset.delta||0);!o||!s||(async()=>(await x.adjustQty(o,s),await b(),await m()))()},{capture:!1})}async function m(){const t=document.getElementById("diag");if(!t)return;const e=typeof Notification<"u"&&"permission"in Notification?Notification.permission:"n/a",n=K(),i=V(),r=n?i:!0,o=l=>l?l.length>12?`${l.slice(0,6)}…${l.slice(-4)}`:l:"-";let s="n/a",d="-";try{const p=window.OneSignal?.User?.PushSubscription;if(p){s=String(p.optedIn??"n/a");const I=p.id;I?.then?d=o(await I):d=o(I)}}catch{}let a=[];try{a=(await navigator.serviceWorker?.getRegistrations?.()??[]).map(p=>`- scope: ${p.scope}`)}catch{}t.textContent=`[DIAG]
  mode: ${i?"standalone":"browser"}
  ios: ${n}
  eligible(iOS=PWAのみ): ${r}
  permission: ${e}
  subscribed: ${s}
  subscriptionId: ${d}
  APP_ID: present
  origin: ${location.origin}
  path:   ${location.pathname}
  SW:
${a.length?a.join(`
`):"- (none)"}
`;const u=document.getElementById("perm-badge");u&&(u.textContent=`権限: ${e}`)}async function lt(){if(!("serviceWorker"in navigator)){c("SW API unavailable");return}try{(await navigator.serviceWorker.getRegistrations()).some(n=>n.scope.includes("/stocklite/"))?c("SW already present for /stocklite/"):(await navigator.serviceWorker.register("/stocklite/OneSignalSDKWorker.js",{scope:"/stocklite/"}),c("SW registered: /stocklite/OneSignalSDKWorker.js"))}catch(t){c(`SW register error: ${t?.message||t}`)}}function ft(){return new Promise(t=>{try{window.OneSignal=window.OneSignal||[],window.OneSignal.push(()=>{try{window.OneSignal.init({appId:ot,serviceWorkerPath:"/stocklite/OneSignalSDKWorker.js",serviceWorkerUpdaterPath:"/stocklite/OneSignalSDKUpdaterWorker.js",serviceWorkerParam:{scope:"/stocklite/"},promptOptions:{slidedown:{enabled:!1}}}),t()}catch(e){c(`OneSignal.init error: ${e?.message||e}`),t()}})}catch(e){c(`OneSignal bootstrap error: ${e?.message||e}`),t()}})}async function y(t){try{if(Notification?.permission!=="granted")return;const e=window.OneSignal?.User?.PushSubscription;if(!e||e.optedIn===!0)return;c(`[ensureSubscribed] try optIn (${t})`),await e.optIn(),await m()}catch(e){c(`[ensureSubscribed] error: ${e?.message||e}`)}}(async()=>(await rt(it),await b(),await lt(),await ft(),await m(),y("after-init"),window.addEventListener("online",()=>{b(),m()}),window.addEventListener("offline",()=>{b(),m()}),document.addEventListener("visibilitychange",()=>{document.hidden||(m(),y("visibilitychange"))})))();

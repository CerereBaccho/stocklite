(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const S=(t,e)=>e.some(n=>t instanceof n);let E,$;function R(){return E||(E=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function W(){return $||($=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const I=new WeakMap,h=new WeakMap,p=new WeakMap;function T(t){const e=new Promise((n,r)=>{const i=()=>{t.removeEventListener("success",o),t.removeEventListener("error",s)},o=()=>{n(f(t.result)),i()},s=()=>{r(t.error),i()};t.addEventListener("success",o),t.addEventListener("error",s)});return p.set(e,t),e}function F(t){if(I.has(t))return;const e=new Promise((n,r)=>{const i=()=>{t.removeEventListener("complete",o),t.removeEventListener("error",s),t.removeEventListener("abort",s)},o=()=>{n(),i()},s=()=>{r(t.error||new DOMException("AbortError","AbortError")),i()};t.addEventListener("complete",o),t.addEventListener("error",s),t.addEventListener("abort",s)});I.set(t,e)}let D={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return I.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function x(t){D=t(D)}function V(t){return W().includes(t)?function(...e){return t.apply(P(this),e),f(this.request)}:function(...e){return f(t.apply(P(this),e))}}function q(t){return typeof t=="function"?V(t):(t instanceof IDBTransaction&&F(t),S(t,R())?new Proxy(t,D):t)}function f(t){if(t instanceof IDBRequest)return T(t);if(h.has(t))return h.get(t);const e=q(t);return e!==t&&(h.set(t,e),p.set(e,t)),e}const P=t=>p.get(t);function U(t,e,{blocked:n,upgrade:r,blocking:i,terminated:o}={}){const s=indexedDB.open(t,e),d=f(s);return r&&s.addEventListener("upgradeneeded",a=>{r(f(s.result),a.oldVersion,a.newVersion,f(s.transaction),a)}),n&&s.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),d.then(a=>{o&&a.addEventListener("close",()=>o()),i&&a.addEventListener("versionchange",c=>i(c.oldVersion,c.newVersion,c))}).catch(()=>{}),d}const K=["get","getKey","getAll","getAllKeys","count"],H=["put","add","delete","clear"],b=new Map;function B(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(b.get(e))return b.get(e);const n=e.replace(/FromIndex$/,""),r=e!==n,i=H.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(i||K.includes(n)))return;const o=async function(s,...d){const a=this.transaction(s,i?"readwrite":"readonly");let c=a.store;return r&&(c=c.index(d.shift())),(await Promise.all([c[n](...d),i&&a.done]))[0]};return b.set(e,o),o}x(t=>({...t,get:(e,n,r)=>B(e,n)||t.get(e,n,r),has:(e,n)=>!!B(e,n)||t.has(e,n)}));const _=["continue","continuePrimaryKey","advance"],L={},O=new WeakMap,C=new WeakMap,Q={get(t,e){if(!_.includes(e))return t[e];let n=L[e];return n||(n=L[e]=function(...r){O.set(this,C.get(this)[e](...r))}),n}};async function*Y(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,Q);for(C.set(n,e),p.set(n,P(e));e;)yield n,e=await(O.get(n)||e.continue()),O.delete(n)}function A(t,e){return e===Symbol.asyncIterator&&S(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&S(t,[IDBIndex,IDBObjectStore])}x(t=>({...t,get(e,n,r){return A(e,n)?Y:t.get(e,n,r)},has(e,n){return A(e,n)||t.has(e,n)}}));const J="stocklite",z=1;let l;function g(t=new Date){return new Date(t).toISOString()}l=U(J,z,{upgrade(t){t.createObjectStore("items",{keyPath:"id"}).createIndex("byCategory","category"),t.createObjectStore("history",{keyPath:["itemId","date"]})}});const M={async getItems(){return(await l).getAll("items")},async upsert(t){const e=await l;t.updatedAt=g(),await e.put("items",t)},async adjustQty(t,e){const r=(await l).transaction(["items","history"],"readwrite"),i=await r.objectStore("items").get(t);if(!i)return;const o=i.qty;i.qty=Math.max(0,o+e),e>0&&(i.lastRefillAt=g());const d=(await r.objectStore("history").getAll()).filter(a=>a.itemId===t&&a.type==="補充").map(a=>+new Date(a.date)).sort((a,c)=>c-a);if(d.length>=2){const a=[];for(let w=0;w<Math.min(3,d.length-1);w++)a.push(d[w]-d[w+1]);const c=a.reduce((w,k)=>w+k,0)/a.length;i.nextRefillAt=g(new Date(Date.now()+c))}await r.objectStore("items").put(i),await r.objectStore("history").put({itemId:t,date:g(),delta:e,type:e>0?"補充":"消費"}),await r.done},async getHistory(t,e){const r=await(await l).getAll("history"),i=new Date;return i.setMonth(i.getMonth()-e),r.filter(o=>o.itemId===t&&new Date(o.date)>=i).sort((o,s)=>+new Date(o.date)-+new Date(s.date))},async exportCSV(t=1){const n=await(await l).getAll("history"),r=new Date;r.setFullYear(r.getFullYear()-t);const i=[["itemId","date","delta","type"]];return n.filter(o=>new Date(o.date)>=r).forEach(o=>i.push([o.itemId,o.date,String(o.delta),o.type])),i.map(o=>o.join(",")).join(`
`)}};async function G(t){const e=await l;if((await e.getAllKeys("items")).length>0)return;const n=e.transaction("items","readwrite");for(const r of t)await n.store.put(r);await n.done}const N=new Date().toISOString(),u=(t,e,n=1)=>({id:crypto.randomUUID(),name:t,qty:1,threshold:n,lastRefillAt:N,nextRefillAt:"",updatedAt:N,deleted:!1,version:1,category:e}),X=[u("トイレットペーパー","キッチン"),u("キッチンペーパー","キッチン"),u("ラップ","キッチン"),u("食器洗剤","キッチン"),u("スポンジ","キッチン"),u("排水溝ネット","キッチン"),u("歯磨き粉","洗面・トイレ"),u("シャンプー","洗面・トイレ"),u("ボディソープ","洗面・トイレ"),u("トイレ用洗剤","洗面・トイレ")],Z="8e78387b-2f78-4458-907e-938de4df59f6",tt=t=>document.querySelector(t);function m(t){const e=tt("#diag");if(!e)return;const n=new Date().toISOString().slice(11,19);e.textContent=`${e.textContent??""}${n} ${t}
`}window.onerror=function(t,e,n,r,i){return m(`[ERROR] ${String(t)} @${e}:${n}:${r}
${i?.stack??""}`),!1};window.onunhandledrejection=function(t){const e=t.reason;m(`[UNHANDLED] ${e?.message??String(e)}
${e?.stack??""}`)};const et=t=>{if(!t)return"--/--";const e=new Date(t);return isNaN(+e)?"--/--":`${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}`};function j(t){const e=t.qty<=t.threshold;return`
  <div class="card" data-id="${t.id}">
    <div class="row1">
      ${e?'<span class="tag danger">要補充</span>':""}
      <span class="item-name ${e?"":"no-tag"}">${t.name}</span>
    </div>
    <div class="row2">
      <span>個数：${t.qty}</span>
      <div class="btns">
        <button class="btn dec" data-id="${t.id}" data-delta="-1">−</button>
        <button class="btn inc" data-id="${t.id}" data-delta="1">＋</button>
      </div>
    </div>
    <div class="row3">次回補充：${et(t.nextRefillAt)}</div>
  </div>`}async function y(){const t=document.getElementById("app"),e=await M.getItems(),n={キッチン:[],"洗面・トイレ":[]};for(const r of e)r.deleted||n[r.category].push(r);for(const r of Object.keys(n))n[r].sort((i,o)=>i.name.localeCompare(o.name,"ja-JP"));t.innerHTML=`
    <div class="offline ${navigator.onLine?"hide":""}">オフライン閲覧中</div>
    <h2 class="cat">【キッチン】</h2>
    ${n.キッチン.map(j).join("")||'<div class="empty">なし</div>'}
    <h2 class="cat">【洗面・トイレ】</h2>
    ${n["洗面・トイレ"].map(j).join("")||'<div class="empty">なし</div>'}
  `,t.onclick=async r=>{const i=r.target;if(i&&i.classList.contains("btn")){const o=i.dataset.id,s=Number(i.dataset.delta||0);if(!o||!s)return;await M.adjustQty(o,s),await y(),await v()}}}async function v(){const t=document.getElementById("diag");if(!t)return;const e=typeof Notification<"u"&&"permission"in Notification?Notification.permission:"n/a";let n="n/a";try{window.OneSignal?.User?.PushSubscription?.optedIn!=null?n=String(window.OneSignal.User.PushSubscription.optedIn):window.OneSignal?.isPushNotificationsEnabled&&(n=String(await window.OneSignal.isPushNotificationsEnabled()))}catch{}let r=[];try{r=(await navigator.serviceWorker?.getRegistrations?.()??[]).map(s=>`${s.scope}`)}catch{}t.textContent=`APP_ID: present
UA:     ${navigator.userAgent}
perm:   ${e}
subscribed: ${n}
SW:
${r.length?r.join(`
`):"- (none)"}
`;const i=document.getElementById("perm-badge");i&&(i.textContent=`権限: ${e}`)}function nt(){return new Promise(t=>{try{window.OneSignal=window.OneSignal||[],window.OneSignal.push(()=>{try{window.OneSignal.init({appId:Z,serviceWorkerPath:"OneSignalSDKWorker.js",serviceWorkerUpdaterPath:"OneSignalSDKUpdaterWorker.js",serviceWorkerParam:{scope:"/stocklite/"},promptOptions:{slidedown:{enabled:!1}}}),t()}catch(e){m(`OneSignal.init error: ${e?.message||e}`),t()}})}catch(e){m(`OneSignal bootstrap error: ${e?.message||e}`),t()}})}async function it(){try{if(window.OneSignal?.Slidedown?.promptPush){await window.OneSignal.Slidedown.promptPush();return}}catch{}try{if(window.OneSignal?.Notifications?.requestPermission){await window.OneSignal.Notifications.requestPermission();return}}catch{}try{if(window.OneSignal?.registerForPushNotifications){await window.OneSignal.registerForPushNotifications();return}}catch{}try{if("Notification"in window&&typeof Notification.requestPermission=="function"){await Notification.requestPermission();return}}catch{}m("No permission prompt API available")}(async()=>{await G(X),await y(),await nt(),await v(),window.addEventListener("online",()=>y()),window.addEventListener("offline",()=>y());const t=document.getElementById("enable-push");t&&t.addEventListener("click",async()=>{await it(),await v()})})();

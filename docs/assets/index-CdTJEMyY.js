(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const I=(t,e)=>e.some(n=>t instanceof n);let B,L;function K(){return B||(B=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function U(){return L||(L=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const D=new WeakMap,g=new WeakMap,w=new WeakMap;function q(t){const e=new Promise((n,s)=>{const r=()=>{t.removeEventListener("success",o),t.removeEventListener("error",a)},o=()=>{n(f(t.result)),r()},a=()=>{s(t.error),r()};t.addEventListener("success",o),t.addEventListener("error",a)});return w.set(e,t),e}function H(t){if(D.has(t))return;const e=new Promise((n,s)=>{const r=()=>{t.removeEventListener("complete",o),t.removeEventListener("error",a),t.removeEventListener("abort",a)},o=()=>{n(),r()},a=()=>{s(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",o),t.addEventListener("error",a),t.addEventListener("abort",a)});D.set(t,e)}let S={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return D.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function N(t){S=t(S)}function Y(t){return U().includes(t)?function(...e){return t.apply(v(this),e),f(this.request)}:function(...e){return f(t.apply(v(this),e))}}function Q(t){return typeof t=="function"?Y(t):(t instanceof IDBTransaction&&H(t),I(t,K())?new Proxy(t,S):t)}function f(t){if(t instanceof IDBRequest)return q(t);if(g.has(t))return g.get(t);const e=Q(t);return e!==t&&(g.set(t,e),w.set(e,t)),e}const v=t=>w.get(t);function G(t,e,{blocked:n,upgrade:s,blocking:r,terminated:o}={}){const a=indexedDB.open(t,e),d=f(a);return s&&a.addEventListener("upgradeneeded",i=>{s(f(a.result),i.oldVersion,i.newVersion,f(a.transaction),i)}),n&&a.addEventListener("blocked",i=>n(i.oldVersion,i.newVersion,i)),d.then(i=>{o&&i.addEventListener("close",()=>o()),r&&i.addEventListener("versionchange",c=>r(c.oldVersion,c.newVersion,c))}).catch(()=>{}),d}const J=["get","getKey","getAll","getAllKeys","count"],z=["put","add","delete","clear"],h=new Map;function M(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(h.get(e))return h.get(e);const n=e.replace(/FromIndex$/,""),s=e!==n,r=z.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(r||J.includes(n)))return;const o=async function(a,...d){const i=this.transaction(a,r?"readwrite":"readonly");let c=i.store;return s&&(c=c.index(d.shift())),(await Promise.all([c[n](...d),r&&i.done]))[0]};return h.set(e,o),o}N(t=>({...t,get:(e,n,s)=>M(e,n)||t.get(e,n,s),has:(e,n)=>!!M(e,n)||t.has(e,n)}));const X=["continue","continuePrimaryKey","advance"],j={},P=new WeakMap,R=new WeakMap,Z={get(t,e){if(!X.includes(e))return t[e];let n=j[e];return n||(n=j[e]=function(...s){P.set(this,R.get(this)[e](...s))}),n}};async function*tt(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,Z);for(R.set(n,e),w.set(n,v(e));e;)yield n,e=await(P.get(n)||e.continue()),P.delete(n)}function A(t,e){return e===Symbol.asyncIterator&&I(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&I(t,[IDBIndex,IDBObjectStore])}N(t=>({...t,get(e,n,s){return A(e,n)?tt:t.get(e,n,s)},has(e,n){return A(e,n)||t.has(e,n)}}));const et="stocklite",nt=1;let l;function m(t=new Date){return new Date(t).toISOString()}l=G(et,nt,{upgrade(t){t.createObjectStore("items",{keyPath:"id"}).createIndex("byCategory","category"),t.createObjectStore("history",{keyPath:["itemId","date"]})}});const $={async getItems(){return(await l).getAll("items")},async upsert(t){const e=await l;t.updatedAt=m(),await e.put("items",t)},async adjustQty(t,e){const s=(await l).transaction(["items","history"],"readwrite"),r=await s.objectStore("items").get(t);if(!r)return;const o=r.qty;r.qty=Math.max(0,o+e),e>0&&(r.lastRefillAt=m());const d=(await s.objectStore("history").getAll()).filter(i=>i.itemId===t&&i.type==="補充").map(i=>+new Date(i.date)).sort((i,c)=>c-i);if(d.length>=2){const i=[];for(let y=0;y<Math.min(3,d.length-1);y++)i.push(d[y]-d[y+1]);const c=i.reduce((y,F)=>y+F,0)/i.length;r.nextRefillAt=m(new Date(Date.now()+c))}await s.objectStore("items").put(r),await s.objectStore("history").put({itemId:t,date:m(),delta:e,type:e>0?"補充":"消費"}),await s.done},async getHistory(t,e){const s=await(await l).getAll("history"),r=new Date;return r.setMonth(r.getMonth()-e),s.filter(o=>o.itemId===t&&new Date(o.date)>=r).sort((o,a)=>+new Date(o.date)-+new Date(a.date))},async exportCSV(t=1){const n=await(await l).getAll("history"),s=new Date;s.setFullYear(s.getFullYear()-t);const r=[["itemId","date","delta","type"]];return n.filter(o=>new Date(o.date)>=s).forEach(o=>r.push([o.itemId,o.date,String(o.delta),o.type])),r.map(o=>o.join(",")).join(`
`)}};async function rt(t){const e=await l;if((await e.getAllKeys("items")).length>0)return;const n=e.transaction("items","readwrite");for(const s of t)await n.store.put(s);await n.done}const x=new Date().toISOString(),u=(t,e,n=1)=>({id:crypto.randomUUID(),name:t,qty:1,threshold:n,lastRefillAt:x,nextRefillAt:"",updatedAt:x,deleted:!1,version:1,category:e}),st=[u("トイレットペーパー","キッチン"),u("キッチンペーパー","キッチン"),u("ラップ","キッチン"),u("食器洗剤","キッチン"),u("スポンジ","キッチン"),u("排水溝ネット","キッチン"),u("歯磨き粉","洗面・トイレ"),u("シャンプー","洗面・トイレ"),u("ボディソープ","洗面・トイレ"),u("トイレ用洗剤","洗面・トイレ")],ot="8e78387b-2f78-4458-907e-938de4df59f6",E="/stocklite/",T="/stocklite/OneSignalSDKWorker.js",it="/stocklite/OneSignalSDKUpdaterWorker.js",at=t=>{if(!t)return"--/--";const e=new Date(t);return isNaN(+e)?"--/--":`${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}`};function C(t){const e=t.qty<=t.threshold;return`
  <div class="card" data-id="${t.id}">
    <div class="row1">
      ${e?'<span class="tag danger">要補充</span>':""}
      <span class="item-name ${e?"":"no-tag"}">${t.name}</span>
    </div>
    <div class="row2">
      <span class="qty">個数：<b>${t.qty}</b></span>
      <div class="actions">
        <button class="btn minus" data-id="${t.id}" data-delta="-1" type="button">－</button>
        <button class="btn plus"  data-id="${t.id}" data-delta="1"  type="button">＋</button>
      </div>
    </div>
    <div class="row3">次回補充：${at(t.nextRefillAt)}</div>
  </div>`}const W="sl_push_prompted_once";let b=!1;function ct(){if(!b&&localStorage.getItem(W)!=="1"){b=!0;try{const t=Notification?.requestPermission;typeof t=="function"&&(t(),localStorage.setItem(W,"1"))}catch{}finally{b=!1}}}let V=null,_;const dt=new Promise(t=>{_=t});async function O(){try{if(Notification?.permission!=="granted")return;const e=(V??await dt)?.User?.PushSubscription;if(!e||e.optedIn===!0)return;await e.optIn()}catch{}}async function ut(){if("serviceWorker"in navigator)try{(await navigator.serviceWorker.getRegistrations()).some(n=>n.scope.includes(E))||await navigator.serviceWorker.register(T,{scope:E})}catch{}}function lt(){return new Promise(t=>{try{window.OneSignalDeferred=window.OneSignalDeferred||[],window.OneSignalDeferred.push(async e=>{try{await e.init({appId:ot,serviceWorkerPath:T,serviceWorkerUpdaterPath:it,serviceWorkerParam:{scope:E},promptOptions:{slidedown:{enabled:!1}}}),V=e,_(e);try{e.Notifications.addEventListener("permissionChange",n=>{n?.to==="granted"&&O()})}catch{}t()}catch{t()}})}catch{t()}})}async function p(){const t=document.getElementById("app"),e=await $.getItems(),n={キッチン:[],"洗面・トイレ":[]};for(const s of e)s.deleted||n[s.category].push(s);for(const s of Object.keys(n))n[s].sort((r,o)=>r.name.localeCompare(o.name,"ja-JP"));t.innerHTML=`
    <div class="offline ${navigator.onLine?"hide":""}">オフライン閲覧中</div>
    <h2 class="cat">【キッチン】</h2>
    ${n.キッチン.map(C).join("")||'<div class="empty">なし</div>'}
    <h2 class="cat">【洗面・トイレ】</h2>
    ${n["洗面・トイレ"].map(C).join("")||'<div class="empty">なし</div>'}
  `}let k=!1;function ft(){if(k)return;const t=document.getElementById("app");t&&(t.addEventListener("click",e=>{const n=e.target;if(!n||!n.classList.contains("btn"))return;ct();try{O()}catch{}const s=n.dataset.id,r=Number(n.dataset.delta||0);!s||!r||(async()=>(await $.adjustQty(s,r),await p()))()},{capture:!1,passive:!1}),k=!0)}(async()=>(await rt(st),await p(),ft(),await ut(),await lt(),O(),window.addEventListener("online",()=>{p()}),window.addEventListener("offline",()=>{p()})))();

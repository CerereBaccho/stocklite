(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const P=(t,e)=>e.some(n=>t instanceof n);let M,N;function J(){return M||(M=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Q(){return N||(N=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const O=new WeakMap,v=new WeakMap,I=new WeakMap;function z(t){const e=new Promise((n,i)=>{const r=()=>{t.removeEventListener("success",s),t.removeEventListener("error",c)},s=()=>{n(g(t.result)),r()},c=()=>{i(t.error),r()};t.addEventListener("success",s),t.addEventListener("error",c)});return I.set(e,t),e}function X(t){if(O.has(t))return;const e=new Promise((n,i)=>{const r=()=>{t.removeEventListener("complete",s),t.removeEventListener("error",c),t.removeEventListener("abort",c)},s=()=>{n(),r()},c=()=>{i(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",s),t.addEventListener("error",c),t.addEventListener("abort",c)});O.set(t,e)}let L={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return O.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return g(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function q(t){L=t(L)}function Z(t){return Q().includes(t)?function(...e){return t.apply(E(this),e),g(this.request)}:function(...e){return g(t.apply(E(this),e))}}function tt(t){return typeof t=="function"?Z(t):(t instanceof IDBTransaction&&X(t),P(t,J())?new Proxy(t,L):t)}function g(t){if(t instanceof IDBRequest)return z(t);if(v.has(t))return v.get(t);const e=tt(t);return e!==t&&(v.set(t,e),I.set(e,t)),e}const E=t=>I.get(t);function et(t,e,{blocked:n,upgrade:i,blocking:r,terminated:s}={}){const c=indexedDB.open(t,e),u=g(c);return i&&c.addEventListener("upgradeneeded",a=>{i(g(c.result),a.oldVersion,a.newVersion,g(c.transaction),a)}),n&&c.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),u.then(a=>{s&&a.addEventListener("close",()=>s()),r&&a.addEventListener("versionchange",d=>r(d.oldVersion,d.newVersion,d))}).catch(()=>{}),u}const nt=["get","getKey","getAll","getAllKeys","count"],rt=["put","add","delete","clear"],$=new Map;function j(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if($.get(e))return $.get(e);const n=e.replace(/FromIndex$/,""),i=e!==n,r=rt.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!(r||nt.includes(n)))return;const s=async function(c,...u){const a=this.transaction(c,r?"readwrite":"readonly");let d=a.store;return i&&(d=d.index(u.shift())),(await Promise.all([d[n](...u),r&&a.done]))[0]};return $.set(e,s),s}q(t=>({...t,get:(e,n,i)=>j(e,n)||t.get(e,n,i),has:(e,n)=>!!j(e,n)||t.has(e,n)}));const it=["continue","continuePrimaryKey","advance"],B={},k=new WeakMap,K=new WeakMap,st={get(t,e){if(!it.includes(e))return t[e];let n=B[e];return n||(n=B[e]=function(...i){k.set(this,K.get(this)[e](...i))}),n}};async function*ot(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,st);for(K.set(n,e),I.set(n,E(e));e;)yield n,e=await(k.get(n)||e.continue()),k.delete(n)}function x(t,e){return e===Symbol.asyncIterator&&P(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&P(t,[IDBIndex,IDBObjectStore])}q(t=>({...t,get(e,n,i){return x(e,n)?ot:t.get(e,n,i)},has(e,n){return x(e,n)||t.has(e,n)}}));const at="stocklite",ct=1;let p;function w(t=new Date){return new Date(t).toISOString()}p=et(at,ct,{upgrade(t){t.createObjectStore("items",{keyPath:"id"}).createIndex("byCategory","category"),t.createObjectStore("history",{keyPath:["itemId","date"]})}});const C={async getItems(){return(await p).getAll("items")},async upsert(t){const e=await p;t.updatedAt=w(),await e.put("items",t)},async adjustQty(t,e){const i=(await p).transaction(["items","history"],"readwrite"),r=await i.objectStore("items").get(t);if(!r)return;const s=r.qty;r.qty=Math.max(0,s+e),e>0&&(r.lastRefillAt=w());const u=(await i.objectStore("history").getAll()).filter(a=>a.itemId===t&&a.type==="補充").map(a=>+new Date(a.date)).sort((a,d)=>d-a);if(u.length>=2){const a=[];for(let f=0;f<Math.min(3,u.length-1);f++)a.push(u[f]-u[f+1]);const d=a.reduce((f,G)=>f+G,0)/a.length;r.nextRefillAt=w(new Date(Date.now()+d))}await i.objectStore("items").put(r),await i.objectStore("history").put({itemId:t,date:w(),delta:e,type:e>0?"補充":"消費"}),await i.done},async getHistory(t,e){const i=await(await p).getAll("history"),r=new Date;return r.setMonth(r.getMonth()-e),i.filter(s=>s.itemId===t&&new Date(s.date)>=r).sort((s,c)=>+new Date(s.date)-+new Date(c.date))},async exportCSV(t=1){const n=await(await p).getAll("history"),i=new Date;i.setFullYear(i.getFullYear()-t);const r=[["itemId","date","delta","type"]];return n.filter(s=>new Date(s.date)>=i).forEach(s=>r.push([s.itemId,s.date,String(s.delta),s.type])),r.map(s=>s.join(",")).join(`
`)}};async function dt(t){const e=await p;if((await e.getAllKeys("items")).length>0)return;const n=e.transaction("items","readwrite");for(const i of t)await n.store.put(i);await n.done}const T=new Date().toISOString(),m=(t,e,n=1)=>({id:crypto.randomUUID(),name:t,qty:1,threshold:n,lastRefillAt:T,nextRefillAt:"",updatedAt:T,deleted:!1,version:1,category:e}),ut=[m("トイレットペーパー","キッチン"),m("キッチンペーパー","キッチン"),m("ラップ","キッチン"),m("食器洗剤","キッチン"),m("スポンジ","キッチン"),m("排水溝ネット","キッチン"),m("歯磨き粉","洗面・トイレ"),m("シャンプー","洗面・トイレ"),m("ボディソープ","洗面・トイレ"),m("トイレ用洗剤","洗面・トイレ")],lt="8e78387b-2f78-4458-907e-938de4df59f6",S="/stocklite/",W="/stocklite/OneSignalSDKWorker.js",ft="/stocklite/OneSignalSDKUpdaterWorker.js",A=t=>document.querySelector(t);function o(t){const e=A("#diag");if(!e)return;const n=new Date().toISOString().slice(11,19);e.textContent=`${e.textContent??""}${n} ${t}
`}window.onerror=function(t,e,n,i,r){return o(`[ERROR] ${String(t)} @${e}:${n}:${i}
${r?.stack??""}`),!1};window.onunhandledrejection=function(t){const e=t.reason;o(`[UNHANDLED] ${e?.message??String(e)}
${e?.stack??""}`)};function V(){const t=navigator.platform||"",e=/Mac/i.test(t)&&navigator.maxTouchPoints>1;return/iPhone|iPad|iPod/i.test(t)||e}function F(){return window.matchMedia?.("(display-mode: standalone)")?.matches||navigator.standalone===!0}const mt=t=>{if(!t)return"--/--";const e=new Date(t);return isNaN(+e)?"--/--":`${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}`};function _(t){const e=t.qty<=t.threshold;return`
  <div class="card" data-id="${t.id}">
    <div class="row1">
      ${e?'<span class="tag danger">要補充</span>':""}
      <span class="item-name ${e?"":"no-tag"}">${t.name}</span>
    </div>
    <div class="row2">
      <span class="qty">個数：<b>${t.qty}</b></span>
      <div class="actions">
        <button class="btn minus" data-id="${t.id}" data-delta="-1">－</button>
        <button class="btn plus"  data-id="${t.id}" data-delta="1">＋</button>
      </div>
    </div>
    <div class="row3">次回補充：${mt(t.nextRefillAt)}</div>
  </div>`}const R="sl_push_prompted_once";let D=!1;function pt(){try{const t=Notification?.requestPermission;if(typeof t=="function")return t(),setTimeout(l,250),setTimeout(l,1e3),setTimeout(()=>h("after-iOS-permission"),500),setTimeout(()=>h("after-iOS-permission(2)"),1500),!0}catch(t){o(`iOS PWA requestPermission error: ${t?.message||t}`)}return!1}function gt(){let t=!1;try{window.OneSignal?.Notifications?.requestPermission&&(window.OneSignal.Notifications.requestPermission(),t=!0)}catch{}try{window.OneSignal?.Slidedown?.promptPush&&(window.OneSignal.Slidedown.promptPush(),t=!0)}catch{}try{const e=Notification?.requestPermission;typeof e=="function"&&(e(),t=!0)}catch{}return t?(setTimeout(l,250),setTimeout(l,1e3),setTimeout(()=>h("after-other-permission"),500)):o("No permission prompt API available"),t}function U(t){if(D)return;if(localStorage.getItem(R)==="1"){o("[first-prompt] skipped");return}D=!0;const e=V()&&F()?pt():gt();e&&localStorage.setItem(R,"1"),o(`[first-prompt] via ${t} used:${e}`),e||(D=!1)}let y=null,H;const yt=new Promise(t=>{H=t});let Y=!1;function ht(){return new Promise(t=>{try{window.OneSignalDeferred=window.OneSignalDeferred||[],window.OneSignalDeferred.push(async e=>{try{await e.init({appId:lt,serviceWorkerPath:W,serviceWorkerUpdaterPath:ft,serviceWorkerParam:{scope:S},promptOptions:{slidedown:{enabled:!1}}}),y=e,Y=!0,H(e),o("OneSignal initialized (v16)"),l();try{e.Notifications.addEventListener("display",()=>{o("[os] display event")})}catch{}try{e.Notifications.addEventListener("click",()=>{o("[os] click event")})}catch{}try{e.Notifications.addEventListener("permissionChange",n=>{o(`[perm] ${n?.to??"changed"}`),l(),n?.to==="granted"&&h("permissionChange")})}catch{}try{e.User?.PushSubscription?.addEventListener?.("change",async()=>{o("[sub] change"),await l()})}catch{}t()}catch(n){o(`OneSignal.init error: ${n?.message||n}`),t()}})}catch(e){o(`OneSignal deferred bootstrap error: ${e?.message||e}`),t()}})}async function l(){const t=document.getElementById("diag");if(!t)return;const e=typeof Notification<"u"&&"permission"in Notification?Notification.permission:"n/a",n=V(),i=F(),r=n?i:!0,s=d=>d?d.length>12?`${d.slice(0,6)}…${d.slice(-4)}`:d:"-";let c="n/a",u="-";try{if(y){const d=y.User?.PushSubscription;if(d){c=String(d.optedIn??"n/a");const f=d.id;u=f?.then?s(await f):s(f)}}}catch{}t.textContent=`[DIAG]
  mode: ${i?"standalone":"browser"}
  ios: ${n}
  eligible(iOS=PWAのみ): ${r}
  permission: ${e}
  sdk_ready: ${Y}
  subscribed: ${c}
  subscriptionId: ${u}
  APP_ID: present
  origin: ${location.origin}
  path:   ${location.pathname}
  SW:
${await wt()}
`;const a=document.getElementById("perm-badge");a&&(a.textContent=`権限: ${e}`)}async function wt(){try{const t=await navigator.serviceWorker?.getRegistrations?.()??[];return t.length?t.map(e=>`- scope: ${e.scope}`).join(`
`):"- (none)"}catch{return"- (error)"}}async function bt(){if(!("serviceWorker"in navigator)){o("SW API unavailable");return}try{(await navigator.serviceWorker.getRegistrations()).some(n=>n.scope.includes(S))?o("SW already present for /stocklite/"):(await navigator.serviceWorker.register(W,{scope:S}),o(`SW registered: ${W}`))}catch(t){o(`SW register error: ${t?.message||t}`)}}function St(){"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",t=>{const e=t?.data;if(!(!e||!e.__sl))try{const n=new Date(e.at||Date.now()).toLocaleTimeString();e.type==="OS_SW_PUSH"?o(`[sw/push] hasData:${e.hasData} text:${e.text??"-"} json:${e.json?JSON.stringify(e.json).slice(0,120):"-"}`):e.type==="OS_SW_DISPLAY"?o(`[sw/display] title:${e.title??"-"} body:${e.body??"-"}`):e.type==="OS_SW_CLICK"?o(`[sw/click] title:${e.title??"-"} action:${e.action??"-"}`):o(`[sw/${e.type}] ${n}`)}catch(n){o(`[sw/msg] error: ${n?.message||n}`)}})}async function h(t){try{if(Notification?.permission!=="granted")return;const n=(y??await yt)?.User?.PushSubscription;if(!n||n.optedIn===!0)return;o(`[ensureSubscribed] try optIn (${t})`),await n.optIn(),await l()}catch(e){o(`[ensureSubscribed] error: ${e?.message||e}`)}}async function b(){const t=document.getElementById("app"),e=await C.getItems(),n={キッチン:[],"洗面・トイレ":[]};for(const i of e)i.deleted||n[i.category].push(i);for(const i of Object.keys(n))n[i].sort((r,s)=>r.name.localeCompare(s.name,"ja-JP"));t.innerHTML=`
    <div class="offline ${navigator.onLine?"hide":""}">オフライン閲覧中</div>
    <h2 class="cat">【キッチン】</h2>
    ${n.キッチン.map(_).join("")||'<div class="empty">なし</div>'}
    <h2 class="cat">【洗面・トイレ】</h2>
    ${n["洗面・トイレ"].map(_).join("")||'<div class="empty">なし</div>'}
  `,t.addEventListener("pointerdown",i=>{const r=i.target;!r||!r.classList.contains("btn")||o(`[btn] pointerdown ${r.classList.contains("plus")?"+btn":"-btn"}`)},{capture:!0,passive:!0}),t.addEventListener("click",i=>{const r=i.target;if(!r||!r.classList.contains("btn"))return;U(r.classList.contains("plus")?"+btn":"-btn");try{if(Notification?.permission==="granted"&&y?.User?.PushSubscription){const u=y.User.PushSubscription;u.optedIn!==!0&&(o("[gesture-optIn] fire"),u.optIn().then(()=>l()).catch(a=>o(`[gesture-optIn] error: ${a?.message||a}`)))}}catch(u){o(`[gesture-optIn] caught: ${u?.message||u}`)}const s=r.dataset.id,c=Number(r.dataset.delta||0);!s||!c||(async()=>(await C.adjustQty(s,c),await b(),await l()))()},{capture:!1}),A("#btn-local-notify")?.addEventListener("click",async()=>{try{if(Notification?.permission!=="granted"){o("[local] permission not granted");return}await(await navigator.serviceWorker.getRegistration(S)??await navigator.serviceWorker.ready).showNotification("StockLite テスト通知",{body:`時刻: ${new Date().toLocaleString()}`,tag:"sl-debug"}),o("[local] showNotification sent")}catch(i){o(`[local] error: ${i?.message||i}`)}}),A("#btn-perm")?.addEventListener("click",()=>{U("manual-button")})}(async()=>(await dt(ut),await b(),await bt(),St(),await ht(),await l(),h("after-init"),window.addEventListener("online",()=>{b(),l()}),window.addEventListener("offline",()=>{b(),l()}),document.addEventListener("visibilitychange",()=>{document.hidden||(l(),h("visibilitychange"))})))();

(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const S=(t,e)=>e.some(n=>t instanceof n);let E,x;function W(){return E||(E=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function q(){return x||(x=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const b=new WeakMap,p=new WeakMap,m=new WeakMap;function V(t){const e=new Promise((n,i)=>{const o=()=>{t.removeEventListener("success",r),t.removeEventListener("error",a)},r=()=>{n(f(t.result)),o()},a=()=>{i(t.error),o()};t.addEventListener("success",r),t.addEventListener("error",a)});return m.set(e,t),e}function K(t){if(b.has(t))return;const e=new Promise((n,i)=>{const o=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",a),t.removeEventListener("abort",a)},r=()=>{n(),o()},a=()=>{i(t.error||new DOMException("AbortError","AbortError")),o()};t.addEventListener("complete",r),t.addEventListener("error",a),t.addEventListener("abort",a)});b.set(t,e)}let I={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return b.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function C(t){I=t(I)}function U(t){return q().includes(t)?function(...e){return t.apply(D(this),e),f(this.request)}:function(...e){return f(t.apply(D(this),e))}}function _(t){return typeof t=="function"?U(t):(t instanceof IDBTransaction&&K(t),S(t,W())?new Proxy(t,I):t)}function f(t){if(t instanceof IDBRequest)return V(t);if(p.has(t))return p.get(t);const e=_(t);return e!==t&&(p.set(t,e),m.set(e,t)),e}const D=t=>m.get(t);function H(t,e,{blocked:n,upgrade:i,blocking:o,terminated:r}={}){const a=indexedDB.open(t,e),d=f(a);return i&&a.addEventListener("upgradeneeded",s=>{i(f(a.result),s.oldVersion,s.newVersion,f(a.transaction),s)}),n&&a.addEventListener("blocked",s=>n(s.oldVersion,s.newVersion,s)),d.then(s=>{r&&s.addEventListener("close",()=>r()),o&&s.addEventListener("versionchange",c=>o(c.oldVersion,c.newVersion,c))}).catch(()=>{}),d}const Q=["get","getKey","getAll","getAllKeys","count"],Y=["put","add","delete","clear"],y=new Map;function A(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(y.get(e))return y.get(e);const n=e.replace(/FromIndex$/,""),i=e!==n,o=Y.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!(o||Q.includes(n)))return;const r=async function(a,...d){const s=this.transaction(a,o?"readwrite":"readonly");let c=s.store;return i&&(c=c.index(d.shift())),(await Promise.all([c[n](...d),o&&s.done]))[0]};return y.set(e,r),r}C(t=>({...t,get:(e,n,i)=>A(e,n)||t.get(e,n,i),has:(e,n)=>!!A(e,n)||t.has(e,n)}));const z=["continue","continuePrimaryKey","advance"],L={},O=new WeakMap,R=new WeakMap,G={get(t,e){if(!z.includes(e))return t[e];let n=L[e];return n||(n=L[e]=function(...i){O.set(this,R.get(this)[e](...i))}),n}};async function*J(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,G);for(R.set(n,e),m.set(n,D(e));e;)yield n,e=await(O.get(n)||e.continue()),O.delete(n)}function B(t,e){return e===Symbol.asyncIterator&&S(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&S(t,[IDBIndex,IDBObjectStore])}C(t=>({...t,get(e,n,i){return B(e,n)?J:t.get(e,n,i)},has(e,n){return B(e,n)||t.has(e,n)}}));const X="stocklite",Z=1;let u;function g(t=new Date){return new Date(t).toISOString()}u=H(X,Z,{upgrade(t){t.createObjectStore("items",{keyPath:"id"}).createIndex("byCategory","category"),t.createObjectStore("history",{keyPath:["itemId","date"]})}});const h={async getItems(){return(await u).getAll("items")},async upsert(t){const e=await u;t.updatedAt=g(),await e.put("items",t)},async adjustQty(t,e){const i=(await u).transaction(["items","history"],"readwrite"),o=await i.objectStore("items").get(t);if(!o)return;const r=o.qty;o.qty=Math.max(0,r+e),e>0&&(o.lastRefillAt=g());const d=(await i.objectStore("history").getAll()).filter(s=>s.itemId===t&&s.type==="補充").map(s=>+new Date(s.date)).sort((s,c)=>c-s);if(d.length>=2){const s=[];for(let w=0;w<Math.min(3,d.length-1);w++)s.push(d[w]-d[w+1]);const c=s.reduce((w,F)=>w+F,0)/s.length;o.nextRefillAt=g(new Date(Date.now()+c))}await i.objectStore("items").put(o),await i.objectStore("history").put({itemId:t,date:g(),delta:e,type:e>0?"補充":"消費"}),await i.done},async getHistory(t,e){const i=await(await u).getAll("history"),o=new Date;return o.setMonth(o.getMonth()-e),i.filter(r=>r.itemId===t&&new Date(r.date)>=o).sort((r,a)=>+new Date(r.date)-+new Date(a.date))},async exportCSV(t=1){const n=await(await u).getAll("history"),i=new Date;i.setFullYear(i.getFullYear()-t);const o=[["itemId","date","delta","type"]];return n.filter(r=>new Date(r.date)>=i).forEach(r=>o.push([r.itemId,r.date,String(r.delta),r.type])),o.map(r=>r.join(",")).join(`
`)}};async function tt(t){const e=await u;if((await e.getAllKeys("items")).length>0)return;const n=e.transaction("items","readwrite");for(const i of t)await n.store.put(i);await n.done}const j=new Date().toISOString(),l=(t,e,n=1)=>({id:crypto.randomUUID(),name:t,qty:1,threshold:n,lastRefillAt:j,nextRefillAt:"",updatedAt:j,deleted:!1,version:1,category:e}),et=[l("トイレットペーパー","キッチン"),l("キッチンペーパー","キッチン"),l("ラップ","キッチン"),l("食器洗剤","キッチン"),l("スポンジ","キッチン"),l("排水溝ネット","キッチン"),l("歯磨き粉","洗面・トイレ"),l("シャンプー","洗面・トイレ"),l("ボディソープ","洗面・トイレ"),l("トイレ用洗剤","洗面・トイレ")];let M=!1;async function $(){if(!M){M=!0;try{if(window.OneSignal?.Slidedown?.promptPush){await window.OneSignal.Slidedown.promptPush();return}if(window.OneSignal?.Notifications?.requestPermission){await window.OneSignal.Notifications.requestPermission();return}if(window.OneSignal?.registerForPushNotifications){await window.OneSignal.registerForPushNotifications();return}}catch{}}}async function nt(){const t="purged_sw_v2";if(!localStorage.getItem(t))try{const e=await(navigator.serviceWorker?.getRegistrations?.()??Promise.resolve([]));for(const n of e)try{await n.unregister()}catch{}if("caches"in window){const n=await caches.keys();await Promise.all(n.map(i=>caches.delete(i)))}}finally{localStorage.setItem(t,"1")}}const ot=t=>{if(!t)return"--/--";const e=new Date(t);return`${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}`};function N(t){const e=t.qty<=t.threshold;return`
  <div class="card" data-id="${t.id}">
    <div class="row1">
      ${e?'<span class="tag danger">要補充</span>':""}
      <span class="item-name${e?"":" no-tag"}">${t.name}</span>
    </div>
    <div class="row2">
      <span class="qty">個数：<b>${t.qty}</b></span>
      <div class="actions">
        <button class="btn plus">＋</button>
        <button class="btn minus">－</button>
      </div>
    </div>
    <div class="row3">次回補充：${ot(t.nextRefillAt)}</div>
  </div>`}async function P(){const t=document.getElementById("app"),e=await h.getItems(),n={キッチン:[],"洗面・トイレ":[]};for(const i of e)n[i.category].push(i);for(const i of Object.keys(n))n[i].sort((o,r)=>o.name.localeCompare(r.name,"ja-JP"));t.innerHTML=`
    <div class="offline ${navigator.onLine?"hide":""}">オフライン閲覧中</div>
    <h2 class="cat">【キッチン】</h2>
    ${n.キッチン.map(N).join("")}
    <h2 class="cat">【洗面・トイレ】</h2>
    ${n["洗面・トイレ"].map(N).join("")}
  `,t.querySelectorAll(".plus").forEach(i=>{if(!navigator.onLine){i.disabled=!0;return}i.onclick=async o=>{await $();const r=o.currentTarget.closest(".card").getAttribute("data-id");await h.adjustQty(r,1),P()}}),t.querySelectorAll(".minus").forEach(i=>{if(!navigator.onLine){i.disabled=!0;return}i.onclick=async o=>{await $();const r=o.currentTarget.closest(".card").getAttribute("data-id");await h.adjustQty(r,-1),P()}})}const it="8e78387b-2f78-4458-907e-938de4df59f6";let k=!1,T=null;function rt(){let t=document.getElementById("diag-box");return t||(t=document.createElement("div"),t.id="diag-box",t.style.cssText=`
      position:fixed;left:12px;right:12px;bottom:12px;z-index:9999;
      background:#000;border-radius:10px;color:#98FB98;padding:12px 14px;
      font:12px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;
      max-height:40vh;overflow:auto;white-space:pre-wrap;`,document.body.appendChild(t)),t}async function st(t){try{const e=await fetch(t,{method:"HEAD"});return`${e.status} ${e.statusText}`}catch(e){return`ERR ${e?.message??e}`}}async function v(){const t=rt(),n=(await(navigator.serviceWorker?.getRegistrations?.()??Promise.resolve([]))).map(o=>{const r=o.active?.scriptURL||o.waiting?.scriptURL||o.installing?.scriptURL||"-";return`- scope:${o.scope||"-"}
  script:${r}`}).join(`
`),i="Notification"in window?Notification.permission:"n/a";t.textContent=`[DIAG]
origin: ${location.origin}
pathname: ${location.pathname}
head(/OneSignalSDKWorker.js): ${await st("/OneSignalSDKWorker.js")}
Notification.permission: ${i}
OneSignal loaded: ${!!window.OneSignal}
OneSignal initDone: ${k}
OneSignal initError: ${T??"-"}
SW registrations:
${n||"- n/a"}
`}window.OneSignal=window.OneSignal||[];window.OneSignal.push(async function(){try{await window.OneSignal.init({appId:it,allowLocalhostAsSecureOrigin:!0,promptOptions:{slidedown:{enabled:!0}}}),k=!0;try{window.OneSignal?.Slidedown?.promptPush?await window.OneSignal.Slidedown.promptPush():window.OneSignal?.Notifications?.requestPermission?await window.OneSignal.Notifications.requestPermission():window.OneSignal?.registerForPushNotifications&&await window.OneSignal.registerForPushNotifications()}catch{}}catch(t){T=t?.message??String(t)}finally{v()}});(async()=>(await nt(),await tt(et),await P(),v(),setInterval(v,4e3)))();navigator.serviceWorker?.register("/sw-test.js").catch(()=>{});
